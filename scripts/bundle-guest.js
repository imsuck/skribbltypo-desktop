import { build } from "vite";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const root = path.join(__dirname, "..");

const guestScripts = [
    { entry: "src/guest/interceptor.ts", name: "interceptor" },
    { entry: "src/guest/game-observer.ts", name: "gameObserver" },
    { entry: "src/guest/popups/join-popup.ts", name: "joinPopup" },
    { entry: "src/guest/popups/update-popup.ts", name: "updatePopup" },
];

async function bundle() {
    console.log("Bundling guest scripts...");

    let bundlesContent = "";

    for (const item of guestScripts) {
        const result = await build({
            build: {
                lib: {
                    entry: path.join(root, item.entry),
                    formats: ["iife"],
                    name: item.name,
                    fileName: () => `${item.name}.js`,
                },
                write: false,
                minify: true,
                rollupOptions: {
                    external: ["electron"],
                    output: {
                        extend: true,
                    }
                }
            },
            configFile: false,
        });

        // @ts-ignore
        let code = result[0].output[0].code;

        // Remove variable assignment to return the IIFE result directly
        // Matches "var name = " or "this.name = "
        code = code.replace(/^(?:var|this\.)\w+\s*=\s*/, "");

        // Remove trailing semicolon
        code = code.replace(/;\s*$/, "");

        bundlesContent += `export const ${item.name}Script = ${JSON.stringify(code)};\n`;
    }

    fs.writeFileSync(
        path.join(root, "src/guest/bundles.ts"),
        `// This file is auto-generated by scripts/bundle-guest.js\n${bundlesContent}`
    );
    console.log("Guest scripts bundled successfully!");
}

bundle().catch(err => {
    console.error("Failed to bundle guest scripts:", err);
    process.exit(1);
});
